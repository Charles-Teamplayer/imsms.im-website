# IMSMS Demo Server Configuration
# 이 파일은 apt로 nginx 재설치해도 덮어씌워지지 않습니다
# 서버 경로: /etc/nginx/sites-available/imsms-demo
# 마지막 수정: 2025-12-21
# 관리자: Claude Code
#
# 복구 명령어:
# scp -i ~/.ssh/ollama-chatbot-key.pem server-config/nginx-imsms-demo.conf ubuntu@13.125.2.83:/tmp/
# ssh -i ~/.ssh/ollama-chatbot-key.pem ubuntu@13.125.2.83 "sudo cp /tmp/nginx-imsms-demo.conf /etc/nginx/sites-available/imsms-demo && sudo nginx -t && sudo systemctl reload nginx"

server {
    listen 80 default_server;
    listen [::]:80 default_server;

    root /var/www/html;
    index index.html;

    server_name _;

    # =============================================
    # IMSMS Demo (Port 3000)
    # =============================================

    # 데모 페이지 - 3000번 포트로 프록시
    location = /demo.html {
        proxy_pass http://localhost:3000/demo.html;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 루트 경로도 데모로 (demo.imsms.im 용)
    location = / {
        proxy_pass http://localhost:3000/demo.html;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 데모 API 프록시
    location /api/demo/ {
        proxy_pass http://localhost:3000/api/demo/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 콜백 API 프록시 (IMSMS 백엔드에서 호출)
    location /api/callback/ {
        proxy_pass http://localhost:3000/api/callback/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 프록시 API (api-test.html용)
    location /api/proxy/ {
        proxy_pass http://localhost:3000/api/proxy/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Health check
    location = /health {
        proxy_pass http://localhost:3000/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # =============================================
    # BrandTalk API (Port 3100)
    # =============================================

    location = /api/brandtalk {
        proxy_pass http://localhost:3100/api/brandtalk;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location = /api/auth {
        proxy_pass http://localhost:3100/api/auth;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # =============================================
    # Static Files
    # =============================================

    location / {
        try_files $uri $uri/ =404;
    }

    location ~ \.html$ {
        add_header Content-Type "text/html; charset=utf-8" always;
    }
}
